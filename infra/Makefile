# QueryMe ì„œë¹„ìŠ¤ ê´€ë¦¬ Makefile
#
# ì‚¬ìš©ë²•:
#   make help                    # ë„ì›€ë§ ë³´ê¸°
#   make start                   # ì „ì²´ ì„œë¹„ìŠ¤ ì‹œì‘
#   make stop                    # ì „ì²´ ì„œë¹„ìŠ¤ ì¤‘ì§€
#   make restart                 # ì „ì²´ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
#   make start SERVICE=auth      # íŠ¹ì • ì„œë¹„ìŠ¤ ì‹œì‘
#   make stop SERVICE=auth       # íŠ¹ì • ì„œë¹„ìŠ¤ ì¤‘ì§€
#   make restart SERVICE=auth    # íŠ¹ì • ì„œë¹„ìŠ¤ ì¬ì‹œì‘
#   make start SERVICES="auth gateway"  # ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ì‹œì‘
#   make restart SERVICES="auth connection nl2sql"  # ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
#   make logs SERVICE=auth       # íŠ¹ì • ì„œë¹„ìŠ¤ ë¡œê·¸ ë³´ê¸°
#   make status                  # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
#   make clean                   # ëª¨ë“  ì»¨í…Œì´ë„ˆì™€ ë³¼ë¥¨ ì •ë¦¬
#
# ì§€ì› ì„œë¹„ìŠ¤:
#   - auth (auth_service)
#   - connection (connection_service)
#   - ddl (ddl_session_service)
#   - history (history_service)
#   - nl2sql (nl2sql_service)
#   - gateway
#   - frontend
#   - mariadb

# ì „ì²´ ì„œë¹„ìŠ¤ ëª©ë¡
SERVICES := auth_service connection_service ddl_session_service history_service nl2sql_service gateway frontend mariadb

# ì„œë¹„ìŠ¤ë³„ ë‹¨ì¶•ëª… ë§¤í•‘
AUTH := auth_service
CONNECTION := connection_service
DDL := ddl_session_service
HISTORY := history_service
NL2SQL := nl2sql_service
GATEWAY := gateway
FRONTEND := frontend
MARIADB := mariadb

# ê¸°ë³¸ê°’
SERVICE ?= all
ACTION ?= start

# ìƒ‰ìƒ ì •ì˜
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
BLUE := \033[0;34m
NC := \033[0m # No Color

.PHONY: help start stop restart logs status clean

# ë„ì›€ë§
help:
	@echo "$(BLUE)QueryMe ì„œë¹„ìŠ¤ ê´€ë¦¬ Makefile$(NC)"
	@echo ""
	@echo "$(YELLOW)ì‚¬ìš©ë²•:$(NC)"
	@echo "  make start [SERVICE=service_name]                    # ë‹¨ì¼ ì„œë¹„ìŠ¤ ì‹œì‘"
	@echo "  make start [SERVICES=\"service1 service2\"]          # ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ì‹œì‘"
	@echo "  make stop [SERVICE=service_name]                     # ë‹¨ì¼ ì„œë¹„ìŠ¤ ì¤‘ì§€"
	@echo "  make stop [SERVICES=\"service1 service2\"]           # ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ì¤‘ì§€"
	@echo "  make restart [SERVICE=service_name]                  # ë‹¨ì¼ ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
	@echo "  make restart [SERVICES=\"service1 service2\"]        # ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
	@echo "  make logs [SERVICE=service_name]                     # ì„œë¹„ìŠ¤ ë¡œê·¸ ë³´ê¸°"
	@echo "  make status                                          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
	@echo "  make clean                                           # ëª¨ë“  ì»¨í…Œì´ë„ˆì™€ ë³¼ë¥¨ ì •ë¦¬"
	@echo ""
	@echo "$(YELLOW)ì§€ì› ì„œë¹„ìŠ¤:$(NC)"
	@echo "  - auth (auth_service)"
	@echo "  - connection (connection_service)"
	@echo "  - ddl (ddl_session_service)"
	@echo "  - history (history_service)"
	@echo "  - nl2sql (nl2sql_service)"
	@echo "  - gateway"
	@echo "  - frontend"
	@echo "  - mariadb"
	@echo "  - all (ì „ì²´ ì„œë¹„ìŠ¤)"
	@echo ""
	@echo "$(YELLOW)ì˜ˆì‹œ:$(NC)"
	@echo "  make start                                           # ì „ì²´ ì„œë¹„ìŠ¤ ì‹œì‘"
	@echo "  make start SERVICE=auth                              # auth_serviceë§Œ ì‹œì‘"
	@echo "  make start SERVICES=\"auth gateway\"                 # authì™€ gateway ì‹œì‘"
	@echo "  make restart SERVICES=\"auth connection nl2sql\"     # 3ê°œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
	@echo "  make logs SERVICE=nl2sql                              # nl2sql_service ë¡œê·¸ ë³´ê¸°"
	@echo "  make backend                                         # ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë“¤ë§Œ ì‹œì‘"
	@echo "  make stop-backend                                    # ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë“¤ë§Œ ì¤‘ì§€"
	@echo "  make restart-api                                     # API ì„œë¹„ìŠ¤ë“¤ë§Œ ì¬ì‹œì‘"
	@echo "  make auth                                            # auth_serviceë§Œ ì‹œì‘"
	@echo "  make stop-auth                                       # auth_serviceë§Œ ì¤‘ì§€"

# ì„œë¹„ìŠ¤ ì‹œì‘
start:
	@if [ "$(SERVICE)" != "all" ] && [ -n "$(SERVICE)" ]; then \
		echo "$(GREEN)ğŸš€ $(SERVICE) ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘...$(NC)"; \
		docker compose up -d $(SERVICE); \
	else \
		echo "$(GREEN)ğŸš€ ì „ì²´ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘...$(NC)"; \
		docker compose up -d; \
	fi
	@echo "$(GREEN)âœ… ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ!$(NC)"

# ì„œë¹„ìŠ¤ ì¤‘ì§€
stop:
	@if [ "$(SERVICE)" != "all" ] && [ -n "$(SERVICE)" ]; then \
		echo "$(YELLOW)â¹ï¸  $(SERVICE) ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘...$(NC)"; \
		docker compose down $(SERVICE); \
	else \
		echo "$(YELLOW)â¹ï¸  ì „ì²´ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘...$(NC)"; \
		docker compose down; \
	fi
	@echo "$(YELLOW)âœ… ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ!$(NC)"

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
restart:
	@if [ "$(SERVICE)" != "all" ] && [ -n "$(SERVICE)" ]; then \
		echo "$(BLUE)ğŸ”„ $(SERVICE) ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘...$(NC)"; \
		docker compose down $(SERVICE); \
		docker compose up -d $(SERVICE); \
	else \
		echo "$(BLUE)ğŸ”„ ì „ì²´ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘...$(NC)"; \
		docker compose down; \
		docker compose up -d; \
	fi
	@echo "$(BLUE)âœ… ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ!$(NC)"

# ì„œë¹„ìŠ¤ ë¡œê·¸ ë³´ê¸°
logs:
	@if [ "$(SERVICE)" = "all" ]; then \
		echo "$(GREEN)ğŸ“‹ ì „ì²´ ì„œë¹„ìŠ¤ ë¡œê·¸ ë³´ê¸°$(NC)"; \
		docker compose logs -f; \
	else \
		echo "$(GREEN)ğŸ“‹ $(SERVICE) ì„œë¹„ìŠ¤ ë¡œê·¸ ë³´ê¸°$(NC)"; \
		docker compose logs -f $(SERVICE); \
	fi

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
status:
	@echo "$(BLUE)ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸$(NC)"
	@docker compose ps

# ëª¨ë“  ì»¨í…Œì´ë„ˆì™€ ë³¼ë¥¨ ì •ë¦¬
clean:
	@echo "$(RED)ğŸ§¹ ëª¨ë“  ì»¨í…Œì´ë„ˆì™€ ë³¼ë¥¨ ì •ë¦¬ ì¤‘...$(NC)"
	@docker compose down -v
	@docker system prune -f
	@echo "$(RED)âœ… ì •ë¦¬ ì™„ë£Œ!$(NC)"

# ë¯¸ë¦¬ ì •ì˜ëœ ì„œë¹„ìŠ¤ ê·¸ë£¹ë“¤ - ì‹œì‘
backend:
	@echo "$(GREEN)ğŸš€ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë“¤ ì‹œì‘ ì¤‘...$(NC)"
	@docker compose up -d auth_service connection_service ddl_session_service history_service nl2sql_service
	@echo "$(GREEN)âœ… ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ!$(NC)"

api:
	@echo "$(GREEN)ğŸš€ API ì„œë¹„ìŠ¤ë“¤ ì‹œì‘ ì¤‘...$(NC)"
	@docker compose up -d auth_service connection_service ddl_session_service history_service nl2sql_service gateway
	@echo "$(GREEN)âœ… API ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ!$(NC)"

core:
	@echo "$(GREEN)ğŸš€ í•µì‹¬ ì„œë¹„ìŠ¤ë“¤ ì‹œì‘ ì¤‘...$(NC)"
	@docker compose up -d auth_service connection_service gateway
	@echo "$(GREEN)âœ… í•µì‹¬ ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ!$(NC)"

data:
	@echo "$(GREEN)ğŸš€ ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘...$(NC)"
	@docker compose up -d mariadb
	@echo "$(GREEN)âœ… ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ!$(NC)"

# ë¯¸ë¦¬ ì •ì˜ëœ ì„œë¹„ìŠ¤ ê·¸ë£¹ë“¤ - ì¤‘ì§€
stop-backend:
	@echo "$(YELLOW)â¹ï¸  ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë“¤ ì¤‘ì§€ ì¤‘...$(NC)"
	@docker compose down auth_service connection_service ddl_session_service history_service nl2sql_service
	@echo "$(YELLOW)âœ… ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ!$(NC)"

stop-api:
	@echo "$(YELLOW)â¹ï¸  API ì„œë¹„ìŠ¤ë“¤ ì¤‘ì§€ ì¤‘...$(NC)"
	@docker compose down auth_service connection_service ddl_session_service history_service nl2sql_service gateway
	@echo "$(YELLOW)âœ… API ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ!$(NC)"

stop-core:
	@echo "$(YELLOW)â¹ï¸  í•µì‹¬ ì„œë¹„ìŠ¤ë“¤ ì¤‘ì§€ ì¤‘...$(NC)"
	@docker compose down auth_service connection_service gateway
	@echo "$(YELLOW)âœ… í•µì‹¬ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ!$(NC)"

stop-data:
	@echo "$(YELLOW)â¹ï¸  ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘...$(NC)"
	@docker compose down mariadb
	@echo "$(YELLOW)âœ… ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ!$(NC)"

# ë¯¸ë¦¬ ì •ì˜ëœ ì„œë¹„ìŠ¤ ê·¸ë£¹ë“¤ - ì¬ì‹œì‘
restart-backend:
	@echo "$(BLUE)ğŸ”„ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë“¤ ì¬ì‹œì‘ ì¤‘...$(NC)"
	@docker compose down auth_service connection_service ddl_session_service history_service nl2sql_service
	@docker compose up -d auth_service connection_service ddl_session_service history_service nl2sql_service
	@echo "$(BLUE)âœ… ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ!$(NC)"

restart-api:
	@echo "$(BLUE)ğŸ”„ API ì„œë¹„ìŠ¤ë“¤ ì¬ì‹œì‘ ì¤‘...$(NC)"
	@docker compose down auth_service connection_service ddl_session_service history_service nl2sql_service gateway
	@docker compose up -d auth_service connection_service ddl_session_service history_service nl2sql_service gateway
	@echo "$(BLUE)âœ… API ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ!$(NC)"

restart-core:
	@echo "$(BLUE)ğŸ”„ í•µì‹¬ ì„œë¹„ìŠ¤ë“¤ ì¬ì‹œì‘ ì¤‘...$(NC)"
	@docker compose down auth_service connection_service gateway
	@docker compose up -d auth_service connection_service gateway
	@echo "$(BLUE)âœ… í•µì‹¬ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ!$(NC)"

restart-data:
	@echo "$(BLUE)ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘...$(NC)"
	@docker compose down mariadb
	@docker compose up -d mariadb
	@echo "$(BLUE)âœ… ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ!$(NC)"

# ê°œë³„ ì„œë¹„ìŠ¤ë³„ íƒ€ê²Ÿ - ì‹œì‘
auth: SERVICE=auth_service
auth: start

connection: SERVICE=connection_service
connection: start

ddl: SERVICE=ddl_session_service
ddl: start

history: SERVICE=history_service
history: start

nl2sql: SERVICE=nl2sql_service
nl2sql: start

gateway: SERVICE=gateway
gateway: start

frontend: SERVICE=frontend
frontend: start

mariadb: SERVICE=mariadb
mariadb: start

# ê°œë³„ ì„œë¹„ìŠ¤ë³„ íƒ€ê²Ÿ - ì¤‘ì§€
stop-auth: SERVICE=auth_service
stop-auth: stop

stop-connection: SERVICE=connection_service
stop-connection: stop

stop-ddl: SERVICE=ddl_session_service
stop-ddl: stop

stop-history: SERVICE=history_service
stop-history: stop

stop-nl2sql: SERVICE=nl2sql_service
stop-nl2sql: stop

stop-gateway: SERVICE=gateway
stop-gateway: stop

stop-frontend: SERVICE=frontend
stop-frontend: stop

stop-mariadb: SERVICE=mariadb
stop-mariadb: stop

# ê°œë³„ ì„œë¹„ìŠ¤ë³„ íƒ€ê²Ÿ - ì¬ì‹œì‘
restart-auth: SERVICE=auth_service
restart-auth: restart

restart-connection: SERVICE=connection_service
restart-connection: restart

restart-ddl: SERVICE=ddl_session_service
restart-ddl: restart

restart-history: SERVICE=history_service
restart-history: restart

restart-nl2sql: SERVICE=nl2sql_service
restart-nl2sql: restart

restart-gateway: SERVICE=gateway
restart-gateway: restart

restart-frontend: SERVICE=frontend
restart-frontend: restart

restart-mariadb: SERVICE=mariadb
restart-mariadb: restart 